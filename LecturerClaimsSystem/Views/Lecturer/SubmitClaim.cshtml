@model LecturerClaimsSystem.Models.Claim
@{
    ViewData["Title"] = "Submit Claim";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3>📝 Submit New Claim</h3>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" asp-action="SubmitClaim" id="claimForm">
                    <div asp-validation-summary="All" class="text-danger"></div>

                    <div class="mb-3">
                        <label asp-for="HoursWorked" class="form-label">Hours Worked *</label>
                        <input asp-for="HoursWorked" class="form-control" type="number" step="0.5"
                               min="0.5" max="744" required id="hoursWorked" />
                        <span asp-validation-for="HoursWorked" class="text-danger"></span>
                        <small class="form-text text-muted">
                            Enter hours between 0.5 and 744 (max hours in a month)
                        </small>
                    </div>

                    <div class="mb-3">
                        <label asp-for="HourlyRate" class="form-label">Hourly Rate (R) *</label>
                        <input asp-for="HourlyRate" class="form-control" type="number" step="0.01"
                               min="50" max="10000" required id="hourlyRate" />
                        <span asp-validation-for="HourlyRate" class="text-danger"></span>
                        <small class="form-text text-muted">
                            Standard rate: R150 - R500 per hour
                        </small>
                    </div>

                    <!-- AUTO-CALCULATED TOTAL AMOUNT -->
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title">💰 Calculated Total Amount</h5>
                                <h2 class="text-success" id="totalAmount">R 0.00</h2>
                                <small class="text-muted">
                                    This amount is automatically calculated based on hours worked × hourly rate
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- VALIDATION ALERTS -->
                    <div id="validationAlert" class="alert alert-warning" style="display: none;">
                        <strong>⚠️ Validation Warning:</strong>
                        <ul id="validationMessages"></ul>
                    </div>

                    <div class="mb-3">
                        <label asp-for="AdditionalNotes" class="form-label">Additional Notes</label>
                        <textarea asp-for="AdditionalNotes" class="form-control" rows="4"
                                  placeholder="Provide details about the work performed..."></textarea>
                        <span asp-validation-for="AdditionalNotes" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label for="document" class="form-label">Upload Supporting Document</label>
                        <input type="file" name="document" id="document" class="form-control"
                               accept=".pdf,.docx,.xlsx,.doc,.xls" />
                        <small class="form-text text-muted">
                            Accepted formats: PDF, Word, Excel (Max 5MB) - Required for claims over R5,000
                        </small>
                    </div>

                    <div class="mb-3" id="filePreview" style="display:none;">
                        <div class="alert alert-info">
                            <strong>📎 Selected file:</strong> <span id="fileName"></span>
                            <br><strong>Size:</strong> <span id="fileSize"></span>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            ✓ Submit Claim
                        </button>
                        <a asp-action="Index" class="btn btn-secondary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Auto-calculation function
            function calculateTotal() {
                var hours = parseFloat($('#hoursWorked').val()) || 0;
                var rate = parseFloat($('#hourlyRate').val()) || 0;
                var total = hours * rate;

                // Update display with formatted currency
                $('#totalAmount').text('R ' + total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','));

                // Validate and show warnings
                validateClaim(hours, rate, total);
            }

            // Validation function
            function validateClaim(hours, rate, total) {
                var warnings = [];
                var hasWarnings = false;

                // Hours validation
                if (hours > 160) {
                    warnings.push('Hours worked (' + hours + ') exceeds standard monthly limit (160 hours)');
                    hasWarnings = true;
                }

                if (hours > 0 && hours < 1) {
                    warnings.push('Very low hours claimed. Please verify.');
                    hasWarnings = true;
                }

                // Rate validation
                if (rate > 1000) {
                    warnings.push('Hourly rate (R' + rate + ') is unusually high. Requires management approval.');
                    hasWarnings = true;
                }

                if (rate > 0 && rate < 100) {
                    warnings.push('Hourly rate (R' + rate + ') is below recommended minimum (R150)');
                    hasWarnings = true;
                }

                // Total validation
                if (total > 50000) {
                    warnings.push('Total amount (R' + total.toFixed(2) + ') exceeds R50,000. Additional documentation required.');
                    hasWarnings = true;
                }

                // Document requirement check
                if (total > 5000) {
                    var hasDocument = $('#document').val() !== '';
                    if (!hasDocument) {
                        warnings.push('Supporting document is required for claims over R5,000');
                        hasWarnings = true;
                    }
                }

                // Display warnings
                if (hasWarnings) {
                    $('#validationAlert').show();
                    $('#validationMessages').empty();
                    warnings.forEach(function (warning) {
                        $('#validationMessages').append('<li>' + warning + '</li>');
                    });
                } else {
                    $('#validationAlert').hide();
                }

                return !hasWarnings;
            }

            // Calculate on input change
            $('#hoursWorked, #hourlyRate').on('input', calculateTotal);

            // Initial calculation
            calculateTotal();

            // File upload preview
            $('#document').on('change', function (e) {
                var file = e.target.files[0];
                if (file) {
                    var fileSize = (file.size / 1024 / 1024).toFixed(2); // Size in MB
                    $('#fileName').text(file.name);
                    $('#fileSize').text(fileSize + ' MB');
                    $('#filePreview').show();

                    // Validate file size
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size exceeds 5MB limit. Please select a smaller file.');
                        $(this).val('');
                        $('#filePreview').hide();
                    }

                    // Re-validate after file upload
                    calculateTotal();
                } else {
                    $('#filePreview').hide();
                }
            });

            // Form submission validation
            $('#claimForm').on('submit', function (e) {
                var hours = parseFloat($('#hoursWorked').val()) || 0;
                var rate = parseFloat($('#hourlyRate').val()) || 0;
                var total = hours * rate;

                // Basic validation
                if (hours <= 0 || rate <= 0) {
                    e.preventDefault();
                    alert('Please enter valid hours worked and hourly rate.');
                    return false;
                }

                // Confirmation for large claims
                if (total > 20000) {
                    if (!confirm('You are submitting a claim for R' + total.toFixed(2) + '. Do you want to proceed?')) {
                        e.preventDefault();
                        return false;
                    }
                }

                // Show loading state
                $('#submitBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Submitting...');
            });
        });
    </script>
}